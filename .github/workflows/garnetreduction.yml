name: CI

on:
    workflow_dispatch:
    pull_request:
    push:
        branches: [next, qa, main]
        tags: ['v*']

jobs:
    tests:
        runs-on: ubuntu-latest
        defaults:
            run:
                shell: bash -l {0}
        steps:
          - uses: actions/checkout@v4
          - uses: conda-incubator/setup-miniconda@v2
            with:
              auto-update-conda: true
              channels: conda-forge, mantid/label/nightly, oncat
              mamba-version: "*"
              environment-file: environment.yml
          - name: install garnet_reduction
            run: |
                  python -m pip install -e .
          - name: run unit tests
            run: |
                  echo "running unit tests"
                  xvfb-run --server-args="-screen 0 1920x1080x24" -a python -m pytest --cov=src --cov-report=xml --cov-report=term-missing
          - name: Upload coverage reports to Codecov
            uses: codecov/codecov-action@v4.0.1
            with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  slug: neutrons/garnet_reduction
    conda-build:
        runs-on: ubuntu-latest
        defaults:
          run:
            shell: bash -l {0}
        steps:
          - uses: actions/checkout@v4
          - uses: conda-incubator/setup-miniconda@v2
            # with:
            #   auto-update-conda: true
            #   channels: conda-forge, mantid/label/nightly, oncat
            #   mamba-version: "*"
            #   environment-file: environment.yml
          - name: Get Date
            id: get-date
            run: echo "::set-output name=today::$(/bin/date -u '+%Y%m%d')"
            shell: bash

          - name: Cache Conda env
            uses: actions/cache@v4
            with:
              path: ${{ env.CONDA }}/envs
              key:
                conda-${{ runner.os }}--${{ runner.arch }}--${{
                steps.get-date.outputs.today }}-${{
                hashFiles('environment.yml') }}-${{
                env.CACHE_NUMBER }}
            env:
              # Increase this value to reset cache if environment.yml has not changed
              CACHE_NUMBER: 4
            id: cache

          - name: Update environment
            run:
              mamba env create -f environment.yml
            if: steps.cache.outputs.cache-hit != 'true'

          - name: building python wheel
            shell: bash -l {0}
            run: |
              python -m build --wheel --no-isolation
          - name: build conda package
            shell: bash -l {0}
            run: |
              # set up environment
              cd conda.recipe
              echo "versioningit $(versioningit ../)"
              # build the package
              VERSION=$(versioningit ../) conda mambabuild --output-folder . .
              conda verify noarch/garnet_reduction*.tar.bz2
          - name: upload conda package to anaconda
            shell: bash -l {0}
            if: startsWith(github.ref, 'refs/tags/v')
            env:
              ANACONDA_API_TOKEN: ${{ secrets.ANACONDA_TOKEN }}
              IS_RC: ${{ contains(github.ref, 'rc') }}
            run: |
              # label is main or rc depending on the tag-name
              CONDA_LABEL="main"
              if [ "${IS_RC}" = "true" ]; then CONDA_LABEL="rc"; fi
              echo pushing ${{ github.ref }} with label $CONDA_LABEL
              anaconda upload --label $CONDA_LABEL conda.recipe/noarch/garnet_reduction*.tar.bz2
